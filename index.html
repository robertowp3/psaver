<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prompt Saver con Preferiti</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
:root {
  --background-color: #000;
  --text-color: #fff;
  --secondary-background-color: #333;
  --tertiary-background-color: #444;
  --quaternary-background-color: #555;
  --prompt-active-color: #28a745;
  --prompt-active-text-color: #fff;
  --btn-custom-color: #fff;
  --btn-new-bg-color: #28a745;
  --btn-edit-bg-color: #17a2b8;
  --btn-save-bg-color: #28a745;
  --btn-delete-bg-color: #dc3545;
  --btn-copy-bg-color: #ffc107;
  --btn-font-bg-color: #ff9800;
  --btn-share-bg-color: #007bff;
  --btn-favorite-bg-color: #FFD700;
  --btn-import-bg-color: #004085;
  --tag-background-color: #28a745;
  --ql-toolbar-background-color: #555;
  --ql-toolbar-border-color: #444;
  --input-background-color: #fff;
  --input-text-color: #000;
  --link-color: orange;
}

.light-theme {
  --background-color: #fff;
  --text-color: #000;
  --secondary-background-color: #f0f0f0;
  --tertiary-background-color: #e0e0e0;
  --quaternary-background-color: #d0d0d0;
  --ql-toolbar-background-color: #e0e0e0;
  --ql-toolbar-border-color: #ccc;
  --input-background-color: #fff;
  --input-text-color: #000;
  --link-color: orange;
}

body {
  background-color: var(--background-color);
  color: var(--text-color);
  padding: 20px;
}

a {
  color: var(--link-color);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

.category-box {
  background-color: var(--secondary-background-color);
  padding: 20px;
  border-radius: 5px;
  margin-top: 20px;
}

.prompt-title-div.active {
  background-color: var(--prompt-active-color);
  color: var(--prompt-active-text-color);
}

.prompt-content {
  background-color: var(--tertiary-background-color);
  padding: 20px;
  border-radius: 5px;
}

.category-header {
  margin-bottom: 20px;
}

.prompt-titles-container {
  margin-bottom: 20px;
}

.btn-custom {
  color: var(--btn-custom-color);
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-right: 5px;
  margin-bottom: 5px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.btn-custom i {
  margin: 0;
  font-size: 16px;
  color: inherit;
}

.btn-new {
  background-color: var(--btn-new-bg-color);
}

.btn-edit {
  background-color: var(--btn-edit-bg-color);
}

.btn-save {
  background-color: var(--btn-save-bg-color);
  display: none;
}

.btn-delete {
  background-color: var(--btn-delete-bg-color);
}

.btn-copy {
  background-color: var(--btn-copy-bg-color);
}

.btn-font {
  background-color: var(--btn-font-bg-color);
}

.btn-share {
  background-color: var(--btn-share-bg-color);
}

.btn-favorite {
  background-color: var(--btn-favorite-bg-color);
}

.btn-import {
  background-color: var(--btn-import-bg-color);
  color: #fff;
}

.btn-import:hover {
  background-color: #002752;
  color: #fff;
}

.display-prompt-text {
  background-color: var(--quaternary-background-color);
  color: var(--text-color);
  padding: 10px;
  border-radius: 5px;
  border: 1px solid var(--tertiary-background-color);
  margin-bottom: 15px;
  white-space: pre-wrap;
}

.ql-toolbar.ql-snow {
  background-color: var(--ql-toolbar-background-color);
  border: 1px solid var(--ql-toolbar-border-color);
}

.ql-toolbar.ql-snow button,
.ql-toolbar.ql-snow .ql-picker-label,
.ql-toolbar.ql-snow .ql-picker-item {
  color: var(--text-color);
}

.ql-toolbar.ql-snow button svg,
.ql-toolbar.ql-snow button svg path {
  fill: var(--text-color);
}

.ql-toolbar.ql-snow .ql-stroke {
  stroke: var(--text-color);
}

.ql-toolbar.ql-snow .ql-fill {
  fill: var(--text-color);
}

.btn-custom i {
  color: var(--text-color) !important;
}

.btn-import svg {
  fill: var(--text-color) !important;
}

.ql-toolbar.ql-snow .ql-picker.ql-header .ql-picker-options {
  background-color: var(--ql-toolbar-background-color) !important;
}

.ql-toolbar.ql-snow .ql-picker.ql-header .ql-picker-item:hover {
  background-color: var(--tertiary-background-color) !important;
  color: var(--text-color) !important;
}

.ql-editor::placeholder {
  color: #ccc;
}

.ql-toolbar.ql-snow button.ql-active svg,
.ql-toolbar.ql-snow button.ql-active svg path {
  fill: var(--prompt-active-color) !important;
}

.ql-toolbar.ql-snow .ql-picker-options {
  color: var(--text-color) !important;
}

.tag {
  background-color: var(--tag-background-color);
  color: var(--prompt-active-text-color);
  padding: 5px 10px;
  border-radius: 15px;
  margin-right: 5px;
  margin-bottom: 5px;
  display: inline-flex;
  align-items: center;
  font-size: 14px;
}

.tag i {
  margin-left: 5px;
  cursor: pointer;
}

.tags-input {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 5px;
  display: flex;
  flex-wrap: wrap;
  background-color: var(--input-background-color);
  color: var(--input-text-color);
}

.tags-input input {
  border: none;
  outline: none;
  background: transparent;
  color: var(--input-text-color);
  flex: 1;
  min-width: 100px;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
}

.subcategories-container .btn-outline-secondary {
  color: white;
  border-color: white;
  background-color: transparent;
}

.subcategories-container .btn-outline-secondary:hover {
  color: white;
  background-color: #28a745;
  border-color: #28a745;
}

.subcategories-container .btn-outline-secondary.active,
.subcategories-container .btn.active {
  color: white !important;
  background-color: #28a745 !important;
  border-color: #28a745 !important;
}

@media (max-width: 576px) {
  .btn-custom {
    font-size: 14px;
    margin-bottom: 5px;
  }
  .category-header .form-control {
    margin-bottom: 10px;
  }
  .prompt-content {
    padding: 15px;
  }
  .display-prompt-text {
    font-size: 14px;
  }
  .prompt-actions .btn-custom {
    font-size: 14px;
  }
  .tags-input {
    flex-direction: column;
  }
  .tags-input input {
    width: 100%;
    margin-top: 5px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-end mb-3">
    <select id="languageSelect" class="custom-select w-auto mr-2">
      <option value="it">Italiano</option>
      <option value="en">English</option>
    </select>
    <button id="themeToggleBtn" class="btn btn-secondary" title="Dark Mode"><i class="fas fa-moon"></i></button>
  </div>

  <h1 class="text-center" data-translate="promptSaver">Prompt Saver</h1>

  <div class="search-container mb-4">
    <div class="input-group">
      <input type="text" id="searchInput" class="form-control" data-placeholder="searchPromptCategoryTag">
      <div class="input-group-append">
        <button id="searchBtn" class="btn btn-success"><i class="fas fa-search"></i></button>
      </div>
    </div>
  </div>

  <div class="top-section mb-4 w-100">
    <div class="new-category-section w-100">
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="input-group">
            <select id="categorySelect" class="form-control">
              <option value="">Seleziona categoria esistente...</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <input type="text" id="newCategoryInput" class="form-control" data-placeholder="newCategory">
            <div class="input-group-append">
              <button id="addCategoryBtn" class="btn btn-success"><i class="fas fa-plus"></i></button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <input type="text" id="newCategoryInput2" class="form-control" data-placeholder="newCategory">
            <div class="input-group-append">
              <button id="addCategoryBtn2" class="btn btn-success"><i class="fas fa-plus"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex align-items-center mb-3">
        <button id="undoBtn" class="btn btn-warning mr-2">
          <i class="fas fa-undo"></i> <span data-translate="undo">Annulla</span>
        </button>
        <button id="redoBtn" class="btn btn-warning mr-2">
          <i class="fas fa-redo"></i> <span data-translate="redo">Ripristina</span>
        </button>
        <button id="backupBtn" class="btn btn-primary mr-2">
          <i class="fas fa-download"></i> <span data-translate="backupData">Backup Dati</span>
        </button>

        <input type="file" id="importFile" class="d-none" accept=".json">
        <button id="importBtn" class="btn btn-import mr-2">
          <i class="fas fa-upload"></i> <span data-translate="importBackup">Importa Backup</span>
        </button>
        <button id="cleanupBtn" class="btn btn-danger">
          <i class="fas fa-broom"></i> Pulisci Sottocategorie
        </button>
      </div>

      <div id="categories" class="mt-3 d-flex flex-wrap"></div>
    </div>
  </div>

  <div id="prompts-display-container"></div>
  <div id="category-boxes-container"></div>

  <div class="modal fade" id="newPromptModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="newPromptModalLabel" data-translate="newPrompt">Nuovo Prompt</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="newPromptForm">
            <div class="form-group">
              <label for="promptTitle" data-translate="title">Titolo</label>
              <input type="text" class="form-control" id="promptTitle" required>
            </div>
            <div class="form-group">
              <label for="promptPurpose" data-translate="purpose">A cosa serve</label>
              <input type="text" class="form-control" id="promptPurpose" required>
            </div>
            <div class="form-group">
              <label data-translate="description">Descrizione</label>
              <div id="newPromptTextEditor" class="form-control" style="height:200px"></div>
            </div>
            <div class="form-group">
              <label data-translate="tags">Tag</label>
              <div id="newPromptTags" class="tags-input"></div>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-plus"></i> <span data-translate="add">Aggiungi</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editPromptModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="editPromptModalLabel" data-translate="editPrompt">Modifica Prompt</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Chiudi">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="editPromptForm">
            <div class="form-group">
              <label for="editPromptTitle" data-translate="title">Titolo</label>
              <input type="text" class="form-control" id="editPromptTitle" required>
            </div>
            <div class="form-group">
              <label for="editPromptPurpose" data-translate="purpose">A cosa serve</label>
              <input type="text" class="form-control" id="editPromptPurpose" required>
            </div>
            <div class="form-group">
              <label data-translate="description">Descrizione</label>
              <div id="editPromptTextEditor" class="form-control" style="height:200px"></div>
            </div>
            <div class="form-group">
              <label data-translate="tags">Tag</label>
              <div id="editPromptTags" class="tags-input"></div>
            </div>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> <span data-translate="save">Salva</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
const categories = [],
      translations = {
        en: {
          promptSaver: "Prompt Saver",
          searchPromptCategoryTag: "Search prompts, categories or tags...",
          newCategory: "New category",
          backupData: "Backup Data",
          importBackup: "Import Backup",
          favorites: "Favorites",
          noResultsFound: "No results found.",
          add: "Add",
          newPrompt: "New Prompt",
          title: "Title",
          text: "Text",
          tags: "Tags",
          save: "Save",
          editPrompt: "Edit Prompt",
          deletePromptConfirmation: "Are you sure you want to delete this prompt?",
          deleteCategoryConfirmation: "Are you sure you want to delete this category?",
          promptTitlePurposeRequired: "Title, purpose, and description are required.",
          backupImported: "Backup imported successfully!",
          backupImportError: "Error importing backup: ",
          copySuccess: "Text copied to clipboard!",
          shareError: "Error during sharing: ",
          promptCopied: "Text copied to clipboard! You can paste it wherever you like.",
          noFavoritesFound: "No favorites found.",
          searchResults: "Search Results",
          favoritesHeading: "Favorites",
          darkMode: "Dark Mode",
          lightMode: "Light Mode",
          addTag: "Add tag...",
          edit: "Edit",
          copy: "Copy",
          share: "Share",
          delete: "Delete",
          increaseFont: "Increase Font",
          addToFavorites: "Add to Favorites",
          removeFromFavorites: "Remove from Favorites",
          purpose: "What is it for",
          description: "Description",
          removeFromFavoritesConfirmation: "Are you sure you want to remove this prompt from favorites?",
          undo: "Undo",
          redo: "Redo"
        },
        it: {
          promptSaver: "Prompt Saver",
          searchPromptCategoryTag: "Cerca prompt, categoria o tag...",
          newCategory: "Aggiungi a categoria",
          backupData: "Backup Dati",
          importBackup: "Importa Backup",
          favorites: "Preferiti",
          noResultsFound: "Nessun risultato trovato.",
          add: "Aggiungi",
          newPrompt: "Nuovo Prompt",
          title: "Titolo",
          text: "Testo",
          tags: "Tag",
          save: "Salva",
          editPrompt: "Modifica Prompt",
          deletePromptConfirmation: "Sei sicuro di voler eliminare questo prompt?",
          deleteCategoryConfirmation: "Sei sicuro di voler eliminare questa categoria?",
          promptTitlePurposeRequired: "Il titolo, A cosa serve, e la descrizione sono obbligatori.",
          backupImported: "Backup importato con successo!",
          backupImportError: "Errore durante l'importazione del backup: ",
          copySuccess: "Testo copiato negli appunti!",
          shareError: "Errore durante la condivisione: ",
          promptCopied: "Testo copiato negli appunti! Puoi incollarlo dove preferisci.",
          noFavoritesFound: "Nessun preferito trovato.",
          searchResults: "Risultati della ricerca",
          favoritesHeading: "Preferiti",
          darkMode: "Tema Scuro",
          lightMode: "Tema Chiaro",
          addTag: "Aggiungi tag...",
          edit: "Modifica",
          copy: "Copia",
          share: "Condividi",
          delete: "Elimina",
          increaseFont: "Aumenta Font",
          addToFavorites: "Aggiungi ai Preferiti",
          removeFromFavorites: "Rimuovi dai Preferiti",
          purpose: "A cosa serve",
          description: "Descrizione",
          removeFromFavoritesConfirmation: "Sei sicuro di voler rimuovere questo prompt dai preferiti?",
          undo: "Annulla",
          redo: "Ripristina"
        }
      };

let currentEdit = { categoryId: null, promptId: null },
    currentLanguage = "it",
    currentTheme = "dark",
    historyStack = [],
    futureStack = [];

function translatePage() {
  document.querySelectorAll("[data-translate]").forEach(e => {
    const k = e.getAttribute("data-translate");
    e.textContent = translations[currentLanguage][k];
  });
  document.querySelectorAll("[data-placeholder]").forEach(e => {
    const k = e.getAttribute("data-placeholder");
    e.setAttribute("placeholder", translations[currentLanguage][k]);
  });
}

document.getElementById("languageSelect").addEventListener("change", function() {
  currentLanguage = this.value;
  translatePage();
  renderCategories();
});

function applyTheme() {
  if (currentTheme === "dark") {
    document.body.classList.remove("light-theme");
    document.getElementById("themeToggleBtn").innerHTML = '<i class="fas fa-sun"></i>';
    document.getElementById("themeToggleBtn").setAttribute("title", translations[currentLanguage]["lightMode"]);
  } else {
    document.body.classList.add("light-theme");
    document.getElementById("themeToggleBtn").innerHTML = '<i class="fas fa-moon"></i>';
    document.getElementById("themeToggleBtn").setAttribute("title", translations[currentLanguage]["darkMode"]);
  }
}

document.getElementById("themeToggleBtn").addEventListener("click", function() {
  currentTheme = currentTheme === "dark" ? "light" : "dark";
  localStorage.setItem("theme", currentTheme);
  applyTheme();
});

let savedTheme = localStorage.getItem("theme");
if (savedTheme) {
  currentTheme = savedTheme;
}
applyTheme();

const icons = Quill.import("ui/icons");
icons.bold = '<i class="fas fa-bold"></i>';
icons.italic = '<i class="fas fa-italic"></i>';
icons.underline = '<i class="fas fa-underline"></i>';
icons.strike = '<i class="fas fa-strikethrough"></i>';
icons.blockquote = '<i class="fas fa-quote-right"></i>';
icons.code = '<i class="fas fa-code"></i>';
icons.header = '<i class="fas fa-heading"></i>';
icons.list = {
  ordered: '<i class="fas fa-list-ol"></i>',
  bullet: '<i class="fas fa-list-ul"></i>',
  check: '<i class="fas fa-check-square"></i>'
};
icons.align = {
  "": '<i class="fas fa-align-left"></i>',
  center: '<i class="fas fa-align-center"></i>',
  right: '<i class="fas fa-align-right"></i>',
  justify: '<i class="fas fa-align-justify"></i>'
};
icons.link = '<i class="fas fa-link"></i>';
icons.image = '<i class="fas fa-image"></i>';
icons.video = '<i class="fas fa-video"></i>';
icons.clean = '<i class="fas fa-eraser"></i>';
icons.subscript = '<i class="fas fa-subscript"></i>';
icons.superscript = '<i class="fas fa-superscript"></i>';

Quill.register("ui/icons", icons, true);

const quillModules = {
  toolbar: [
    ["bold", "italic", "underline", "strike"],
    [{ align: [] }],
    ["blockquote", "code-block"],
    [{ header: [1, 2, 3, 4, 5, 6, false] }],
    [{ list: "ordered" }, { list: "bullet" }],
    [{ script: "sub" }, { script: "super" }],
    [{ indent: "-1" }, { indent: "+1" }],
    [{ direction: "rtl" }],
    ["link", "image", "video"],
    [{ size: ["small", false, "large", "huge"] }],
    [{ header: [1, 2, 3, 4, 5, 6, false] }],
    [{ color: [] }, { background: [] }],
    [{ font: [] }],
    ["clean"]
  ]
};

const quillNewPrompt = new Quill("#newPromptTextEditor", {
  theme: "snow",
  modules: quillModules
});
const quillEditPrompt = new Quill("#editPromptTextEditor", {
  theme: "snow",
  modules: quillModules
});

const customStyle = document.createElement("style");
customStyle.innerHTML = ".ql-toolbar .ql-formats button i.fas{color:var(--text-color);}";
document.head.appendChild(customStyle);

function sanitizeHTML(t) {
  const d = document.createElement("div");
  d.innerHTML = t;
  return d.textContent || d.innerText || "";
}

function generateUniqueId() {
  return "_" + Math.random().toString(36).substr(2, 9);
}

function loadFromLocalStorage() {
  const s = localStorage.getItem("categories");
  if (s) {
    const p = JSON.parse(s);
    
    p.forEach(c => {
      c.id = c.id || generateUniqueId();
      c.name = sanitizeHTML(c.name);
      c.prompts.forEach(pr => {
        pr.id = pr.id || generateUniqueId();
        pr.title = sanitizeHTML(pr.title);
        pr.purpose = sanitizeHTML(pr.purpose || "");
        pr.description = pr.description || pr.text || "";
        pr.tags = pr.tags || [];
        pr.favorite = pr.favorite || false;
      });
      
      // Clean up invalid subcategories - extremely aggressive filtering
      if (c.subcategories) {
        c.subcategories = c.subcategories.filter(subCat => {
          if (!subCat.name || subCat.name.trim() === "") return false;
          
          const cleanName = subCat.name.trim();
          
          // Remove ALL invalid patterns
          if (cleanName.length < 3) return false; // minimum 3 characters
          if (cleanName.match(/^[a-z]{1,2}$/i)) return false; // single or double letters
          if (cleanName.match(/^[a-z\s]*v$/i)) return false; // ends with v
          if (cleanName.match(/^y+$/i)) return false; // only y's
          if (cleanName.match(/^[a-z]+\s*v\s*$/i)) return false; // letters + v
          if (cleanName.match(/^mb[a-z]*\s*v?$/i)) return false; // starts with mb
          if (cleanName.match(/^cd[a-z]*$/i)) return false; // starts with cd
          if (cleanName.match(/^[a-z]{1,6}\s*v?\s*$/i)) return false; // short random letters
          if (cleanName.match(/^[bcdfghjklmnpqrstvwxyz]{1,4}$/i)) return false; // only consonants (short)
          if (cleanName.match(/^[bcdfghjklmnpqrstvwxyz]+$/i)) return false; // only consonants
          if (cleanName.match(/^[aeiou]{1,3}$/i)) return false; // only vowels (short)
          if (cleanName.match(/^c+d*a*$/i)) return false; // patterns with c, d, a
          if (cleanName.match(/^[cda]+$/i)) return false; // only c, d, a combinations
          if (cleanName.match(/^[xyz]+$/i)) return false; // only x, y, z
          if (cleanName.match(/^\w{1,3}$/)) return false; // any 1-3 character combinations
          
          // Must contain at least one vowel for meaningful words
          if (!cleanName.match(/[aeiou]/i)) return false;
          
          // Must not be random keyboard mashing
          if (cleanName.match(/^[qwerty]+$/i)) return false;
          if (cleanName.match(/^[asdf]+$/i)) return false;
          if (cleanName.match(/^[zxcv]+$/i)) return false;
          
          // Additional validation: must look like a real word
          const invalidPatterns = [
            /^[a-z]\1{2,}$/i, // repeated characters like "aaa"
            /^[a-z]{1,2}[a-z]\2+$/i, // patterns like "aaa", "bbb"
            /^(.)(.)\1\2+$/i, // alternating patterns
          ];
          
          for (let pattern of invalidPatterns) {
            if (cleanName.match(pattern)) return false;
          }
          
          return true;
        }).map(subCat => ({
          ...subCat,
          name: sanitizeHTML(subCat.name.trim()),
          prompts: subCat.prompts || []
        }));
        
        // If all subcategories were filtered out, remove the subcategories property
        if (c.subcategories.length === 0) {
          delete c.subcategories;
        }
      }
    });
    
    categories.push(...p);
    sortCategoriesAndPrompts();
    saveToLocalStorage();
    renderCategories();
  }
}

function saveToLocalStorage() {
  localStorage.setItem("categories", JSON.stringify(categories));
}

function sortCategoriesAndPrompts() {
  categories.sort((a, b) => a.name.localeCompare(b.name, currentLanguage));
  categories.forEach(c => {
    c.prompts.sort((a, b) => a.title.localeCompare(b.title, currentLanguage));
    if (c.subcategories) {
      c.subcategories.sort((a, b) => a.name.localeCompare(b.name, currentLanguage));
      c.subcategories.forEach(sub => {
        sub.prompts.sort((a, b) => a.title.localeCompare(b.title, currentLanguage));
      });
    }
  });
}

function renderCategories() {
  sortCategoriesAndPrompts();
  const container = document.getElementById("categories"),
        catBoxC = document.getElementById("category-boxes-container");
  container.innerHTML = "";
  catBoxC.innerHTML = "";

  const favBtn = document.createElement("button");
  favBtn.className = "btn btn-secondary mr-2 mb-2";
  favBtn.textContent = translations[currentLanguage]["favorites"];
  favBtn.onclick = () => toggleFavoritesView(favBtn);
  container.appendChild(favBtn);

  categories.forEach(c => {
    const b = document.createElement("button");
    b.className = "btn btn-secondary mr-2 mb-2";
    b.textContent = c.name;
    b.onclick = () => toggleCategoryBox(c.id);
    container.appendChild(b);

    const box = createCategoryBox(c);
    box.style.display = "none";
    catBoxC.appendChild(box);
  });

  updateCategoryDropdowns();
}

function updateCategoryDropdowns() {
  const select1 = document.getElementById("categorySelect");
  
  // Clear existing options except the first one
  select1.innerHTML = '<option value="">Seleziona categoria esistente...</option>';
  
  // Add categories to dropdown
  categories.forEach(c => {
    const option1 = document.createElement("option");
    option1.value = c.id;
    option1.textContent = c.name;
    select1.appendChild(option1);
  });
}

function createCategoryBox(c) {
  const cb = document.createElement("div");
  cb.className = "category-box";
  cb.dataset.categoryId = c.id;

  const ch = document.createElement("div");
  ch.className = "category-header d-flex flex-wrap align-items-center";

  const ci = document.createElement("input");
  ci.type = "text";
  ci.value = c.name;
  ci.className = "form-control mr-2 mb-2";
  ci.readOnly = true;
  ch.appendChild(ci);

  const eBtn = createIconButton("info", "edit", translations[currentLanguage]["editPrompt"]),
        sBtn = createIconButton("success", "save", translations[currentLanguage]["save"], true),
        nBtn = createIconButton("success", "plus", translations[currentLanguage]["newPrompt"]);
  nBtn.classList.add("btn-new");

  const dBtn = createIconButton("danger", "trash", translations[currentLanguage]["delete"]);

  ch.appendChild(eBtn);
  ch.appendChild(sBtn);
  ch.appendChild(nBtn);
  ch.appendChild(dBtn);

  cb.appendChild(ch);

  const actDiv = document.createElement("div");
  actDiv.className = "category-actions mt-3";
  actDiv.style.display = "none";

  const aeBtn = createIconButton("info", "edit", translations[currentLanguage]["edit"]),
        acBtn = createIconButton("warning", "copy", translations[currentLanguage]["copy"]),
        asBtn = createIconButton("primary", "share-alt", translations[currentLanguage]["share"]),
        adBtn = createIconButton("danger", "trash", translations[currentLanguage]["delete"]),
        afBtn = createIconButton("secondary", "text-height", translations[currentLanguage]["increaseFont"]),
        favBtn = createIconButton("favorite", "star", translations[currentLanguage]["addToFavorites"]);
  favBtn.classList.add("btn-favorite");

  actDiv.append(aeBtn, acBtn, asBtn, favBtn, adBtn, afBtn);
  cb.appendChild(actDiv);
  cb.actionsDiv = actDiv;

  nBtn.onclick = () => showNewPromptForm(c.id);
  eBtn.onclick = () => {
    ci.readOnly = false;
    toggleButtons(eBtn, sBtn);
  };
  sBtn.onclick = () => {
    ci.readOnly = true;
    toggleButtons(eBtn, sBtn);
    c.name = sanitizeHTML(ci.value);
    pushToHistory();
    sortCategoriesAndPrompts();
    saveToLocalStorage();
    renderCategories();
  };
  dBtn.onclick = () => deleteCategory(c.id);

  const ptc = document.createElement("div");
  ptc.className = "prompt-titles-container d-flex flex-wrap";
  const spc = document.createElement("div");
  spc.className = "selected-prompt-container";

  // Add subcategories if they exist
  if (c.subcategories && c.subcategories.length > 0) {
    const subCatContainer = document.createElement("div");
    subCatContainer.className = "subcategories-container mb-3";
    
    const subCatTitle = document.createElement("h6");
    subCatTitle.textContent = "Sottocategorie:";
    subCatTitle.className = "mb-2";
    subCatContainer.appendChild(subCatTitle);
    
    const subCatButtons = document.createElement("div");
    subCatButtons.className = "d-flex flex-wrap";
    
    c.subcategories.forEach(subCat => {
      const subBtn = document.createElement("button");
      subBtn.className = "btn btn-outline-secondary btn-sm mr-2 mb-2";
      subBtn.textContent = subCat.name;
      subBtn.onclick = () => {
        // Remove active class from all subcategory buttons
        subCatButtons.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
        // Add active class to clicked button
        subBtn.classList.add('active');
        displaySubcategoryPrompts(subCat, c.id, cb);
      };
      subCatButtons.appendChild(subBtn);
    });
    
    subCatContainer.appendChild(subCatButtons);
    cb.appendChild(subCatContainer);
  }

  c.prompts.forEach(p => {
    ptc.appendChild(createPromptTitleDiv(p, c.id));
  });

  cb.appendChild(ptc);
  cb.appendChild(spc);

  aeBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt) openEditModal(c.id, cb.selectedPrompt.id);
  };
  acBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt) copyPromptText(cb.selectedPrompt);
  };
  asBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt) sharePrompt(cb.selectedPrompt);
  };
  adBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt && confirm(translations[currentLanguage]["deletePromptConfirmation"])) {
      deletePrompt(c.id, cb.selectedPrompt.id);
    }
  };
  afBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt) {
      const t = cb.querySelector(".display-prompt-text");
      increaseFontSize(t);
    }
  };
  favBtn.onclick = (e) => {
    e.stopPropagation();
    if (cb.selectedPrompt) toggleFavorite(cb.selectedPrompt, favBtn);
  };

  return cb;
}

function createIconButton(colorClass, iconName, title, hidden = false) {
  const btn = document.createElement("button");
  btn.className = `btn btn-${colorClass} btn-custom mb-2`;
  btn.innerHTML = `<i class="fas fa-${iconName}"></i>`;
  btn.title = title;
  if (hidden) btn.style.display = "none";
  return btn;
}

function toggleButtons(eBtn, sBtn) {
  if (eBtn.style.display === "none") {
    eBtn.style.display = "inline";
    sBtn.style.display = "none";
  } else {
    eBtn.style.display = "none";
    sBtn.style.display = "inline";
  }
}

function createPromptTitleDiv(p, cId) {
  const d = document.createElement("button");
  d.className = "btn btn-secondary mr-2 mb-2";
  d.innerHTML = p.title;
  d.onclick = () => {
    clearSearchResults();
    displaySelectedPrompt(d, p, cId);
  };
  return d;
}

function displaySelectedPrompt(d, p, cId) {
  const cb = d.closest(".category-box"),
        sp = cb.querySelector(".selected-prompt-container");
  sp.innerHTML = "";
  const pd = createPromptContent(p, cId);
  sp.appendChild(pd);
  cb.selectedPrompt = p;

  d.parentElement.querySelectorAll(".btn").forEach(b => b.classList.remove("active"));
  d.classList.add("active");
  cb.actionsDiv.style.display = "block";

  const favBtn = cb.actionsDiv.querySelector(".btn-favorite");
  favBtn.innerHTML = p.favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
  favBtn.title = p.favorite
    ? translations[currentLanguage]["removeFromFavorites"]
    : translations[currentLanguage]["addToFavorites"];
}

function createPromptContent(p, cId) {
  const d = document.createElement("div");
  d.className = "prompt-content";

  const t = document.createElement("h4");
  t.innerHTML = p.title;
  d.appendChild(t);

  const pu = document.createElement("p");
  pu.innerHTML = "<strong>" + translations[currentLanguage]["purpose"] + ":</strong> " + (p.purpose || "");
  d.appendChild(pu);

  d.appendChild(createTagsContainer(p.tags));

  const dd = document.createElement("div");
  dd.className = "display-prompt-text";
  dd.innerHTML = p.description || "";
  d.appendChild(dd);

  return d;
}

function createTagsContainer(tags) {
  const c = document.createElement("div");
  c.className = "tags-container mb-2";
  tags.forEach(t => {
    const ts = document.createElement("span");
    ts.className = "tag";
    ts.textContent = t;
    c.appendChild(ts);
  });
  return c;
}

function copyPromptText(p) {
  const d = document.createElement("div");
  d.innerHTML = p.description;
  const txt = d.textContent || d.innerText || "";
  const htmlContent = p.description;
  
  // Try to copy both HTML and plain text formats
  if (navigator.clipboard && navigator.clipboard.write) {
    const data = [];
    
    // Add HTML format
    data.push(new ClipboardItem({
      'text/html': new Blob([htmlContent], { type: 'text/html' }),
      'text/plain': new Blob([txt], { type: 'text/plain' })
    }));
    
    navigator.clipboard.write(data)
      .then(() => alert(translations[currentLanguage]["copySuccess"]))
      .catch(e => {
        // Fallback to plain text if HTML copy fails
        navigator.clipboard.writeText(txt)
          .then(() => alert(translations[currentLanguage]["copySuccess"]))
          .catch(e => console.error(e));
      });
  } else {
    // Fallback for browsers that don't support clipboard.write
    navigator.clipboard.writeText(txt)
      .then(() => alert(translations[currentLanguage]["copySuccess"]))
      .catch(e => console.error(e));
  }
}

function increaseFontSize(t) {
  const fs = parseInt(window.getComputedStyle(t).fontSize);
  t.style.fontSize = (fs + 1) + "px";
}

function toggleCategoryBox(cId) {
  clearSearchResults();
  document.getElementById("prompts-display-container").innerHTML = "";

  const cbs = document.querySelectorAll(".category-box"),
        cds = document.querySelectorAll("#categories .btn");

  cbs.forEach((b, i) => {
    if (b.dataset.categoryId === cId) {
      const v = b.style.display === "block";
      b.style.display = v ? "none" : "block";
      if (v) {
        cds[i + 1].classList.remove("btn-success");
        cds[i + 1].classList.add("btn-secondary");
        b.selectedPrompt = null;
        if (b.actionsDiv) b.actionsDiv.style.display = "none";
      } else {
        cds[i + 1].classList.remove("btn-secondary");
        cds[i + 1].classList.add("btn-success");
      }
    } else {
      b.style.display = "none";
      if (cds[i + 1]) {
        cds[i + 1].classList.remove("btn-success");
        cds[i + 1].classList.add("btn-secondary");
      }
      b.selectedPrompt = null;
      if (b.actionsDiv) b.actionsDiv.style.display = "none";
    }
  });

  const fb = document.querySelector("#categories .btn:first-child");
  fb.classList.remove("btn-success");
  fb.classList.add("btn-secondary");
}

function showNewPromptForm(cId, subCatId = null) {
  quillNewPrompt.setContents([]);
  initTagsInput("newPromptTags");
  $("#newPromptModal").modal("show");

  $("#newPromptForm").off("submit").on("submit", e => {
    e.preventDefault();
    const title = $("#promptTitle").val().trim(),
          purpose = $("#promptPurpose").val().trim(),
          desc = quillNewPrompt.root.innerHTML.trim(),
          tags = getTags("newPromptTags");

    if (title && purpose && desc && desc !== "") {
      const np = {
        id: generateUniqueId(),
        title: sanitizeHTML(title),
        purpose: sanitizeHTML(purpose),
        description: desc,
        tags: tags.map(t => sanitizeHTML(t)),
        favorite: false
      };
      
      const c = categories.find(cc => cc.id === cId);
      
      if (subCatId) {
        // Add to subcategory
        const subCat = c.subcategories.find(sc => sc.id === subCatId);
        if (subCat) {
          subCat.prompts.push(np);
        }
      } else {
        // Add to main category
        c.prompts.push(np);
      }
      
      pushToHistory();
      sortCategoriesAndPrompts();
      saveToLocalStorage();
      renderCategories();
      toggleCategoryBox(cId);

      const cb = document.querySelector(`.category-box[data-category-id="${cId}"]`),
            pt = cb.querySelectorAll(".prompt-titles-container .btn");
      pt.forEach(b => {
        if (b.textContent === np.title) b.click();
      });

      $("#newPromptModal").modal("hide");
      $("#promptTitle").val("");
      $("#promptPurpose").val("");
      quillNewPrompt.setContents([]);
      resetTags("newPromptTags");
    } else {
      alert(translations[currentLanguage]["promptTitlePurposeRequired"]);
    }
  });
}

function deleteCategory(cId) {
  if (confirm(translations[currentLanguage]["deleteCategoryConfirmation"])) {
    const i = categories.findIndex(c => c.id === cId);
    if (i !== -1) {
      pushToHistory();
      categories.splice(i, 1);
      saveToLocalStorage();
      renderCategories();
    }
  }
}

function deletePrompt(cId, pId) {
  const c = categories.find(cc => cc.id === cId);
  if (c) {
    const i = c.prompts.findIndex(pp => pp.id === pId);
    if (i !== -1) {
      pushToHistory();
      c.prompts.splice(i, 1);
      saveToLocalStorage();
      renderCategories();
    }
  }
}

function clearSearchResults() {
  document.getElementById("prompts-display-container").innerHTML = "";
}

function searchPrompts() {
  const q = document.getElementById("searchInput").value.toLowerCase().trim(),
        pdc = document.getElementById("prompts-display-container");
  pdc.innerHTML = "";

  const h = document.createElement("h2");
  h.textContent = translations[currentLanguage]["searchResults"];
  pdc.appendChild(h);

  let found = false;
  categories.forEach(c => {
    c.prompts.forEach(p => {
      const pt = (p.description || "").toLowerCase(),
            cn = c.name.toLowerCase(),
            tg = p.tags.map(t => t.toLowerCase());

      if (
        p.title.toLowerCase().includes(q) ||
        pt.includes(q) ||
        cn.includes(q) ||
        tg.includes(q)
      ) {
        found = true;
        pdc.appendChild(createPromptContent(p, c.id));
      }
    });
  });

  if (!found) {
    const nf = document.createElement("p");
    nf.textContent = translations[currentLanguage]["noResultsFound"];
    pdc.appendChild(nf);
  }

  document.querySelectorAll(".category-box").forEach(b => b.style.display = "none");
  document.querySelectorAll("#categories .btn").forEach(d => {
    d.classList.remove("btn-success");
    d.classList.add("btn-secondary");
  });
}

// Clear selected category when typing in category input
document.getElementById("newCategoryInput").addEventListener("input", function() {
  selectedCategoryFromDropdown = null;
});

document.getElementById("addCategoryBtn").onclick = function() {
  const cn = document.getElementById("newCategoryInput").value.trim();
  if (cn) {
    const nc = { id: generateUniqueId(), name: sanitizeHTML(cn), prompts: [] };
    pushToHistory();
    categories.push(nc);
    sortCategoriesAndPrompts();
    saveToLocalStorage();
    renderCategories();
    toggleCategoryBox(nc.id);
    document.getElementById("newCategoryInput").value = "";
    selectedCategoryFromDropdown = null; // Reset
  }
};

// Variable to track selected category from dropdown
let selectedCategoryFromDropdown = null;

document.getElementById("addCategoryBtn2").onclick = function() {
  const cn = document.getElementById("newCategoryInput2").value.trim();
  const selectedCategoryBox = document.querySelector('.category-box[style*="block"]');
  
  if (cn && cn.length >= 2) {
    // More permissive validation - only block clearly invalid patterns
    if (cn.length < 2 || 
        cn.match(/^[a-z]{1}$/i) || // single letter only
        cn.match(/^y+$/i) || // only y's
        cn.match(/^[xyz]+$/i) || // only x, y, z
        cn.match(/^[cda]{1,3}$/i) || // only c, d, a (short)
        cn.match(/^mb[a-z]*v$/i) || // specific invalid pattern
        cn.match(/^[qwerty]{1,4}$/i) || // keyboard mashing (short)
        cn.match(/^[asdf]{1,4}$/i)) { // keyboard mashing (short)
      alert("Nome sottocategoria non valido. Inserisci un nome più descrittivo (minimo 2 caratteri).");
      return;
    }
    
    // Priority: 1) Selected from dropdown, 2) Visible category box, 3) Find by name match
    let parentCategory = null;
    let parentCategoryId = null;
    
    if (selectedCategoryFromDropdown) {
      parentCategory = selectedCategoryFromDropdown;
      parentCategoryId = parentCategory.id;
    } else if (selectedCategoryBox) {
      parentCategoryId = selectedCategoryBox.dataset.categoryId;
      parentCategory = categories.find(c => c.id === parentCategoryId);
    } else {
      // Try to find category by matching name in the first input field
      const categoryName = document.getElementById("newCategoryInput").value.trim();
      if (categoryName) {
        parentCategory = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
        if (parentCategory) {
          parentCategoryId = parentCategory.id;
        }
      }
    }
    
    if (parentCategory && parentCategoryId) {
      // Initialize subcategories array if it doesn't exist
      if (!parentCategory.subcategories) {
        parentCategory.subcategories = [];
      }
      
      // Check if subcategory name already exists
      if (parentCategory.subcategories.find(sub => sub.name.toLowerCase() === cn.toLowerCase())) {
        alert("Una sottocategoria con questo nome esiste già.");
        return;
      }
      
      const newSubcategory = { 
        id: generateUniqueId(), 
        name: sanitizeHTML(cn), 
        prompts: [] 
      };
      
      pushToHistory();
      parentCategory.subcategories.push(newSubcategory);
      sortCategoriesAndPrompts();
      saveToLocalStorage();
      renderCategories();
      toggleCategoryBox(parentCategoryId);
      document.getElementById("newCategoryInput2").value = "";
      selectedCategoryFromDropdown = null; // Reset after use
    } else {
      // If no parent category is found, create a main category
      const nc = { id: generateUniqueId(), name: sanitizeHTML(cn), prompts: [] };
      pushToHistory();
      categories.push(nc);
      sortCategoriesAndPrompts();
      saveToLocalStorage();
      renderCategories();
      toggleCategoryBox(nc.id);
      document.getElementById("newCategoryInput2").value = "";
      selectedCategoryFromDropdown = null; // Reset after use
    }
  } else if (cn.length < 2) {
    alert("Il nome deve contenere almeno 2 caratteri.");
  } else if (!cn) {
    alert("Inserisci un nome per la categoria/sottocategoria.");
  }
};

// Handle category dropdown selections
document.getElementById("categorySelect").addEventListener("change", function() {
  const selectedCategoryId = this.value;
  if (selectedCategoryId) {
    // Find the selected category and populate the input field
    const selectedCategory = categories.find(c => c.id === selectedCategoryId);
    if (selectedCategory) {
      document.getElementById("newCategoryInput").value = selectedCategory.name;
      selectedCategoryFromDropdown = selectedCategory; // Track selected category
    }
    toggleCategoryBox(selectedCategoryId);
    this.value = ""; // Reset dropdown
  }
});



document.getElementById("searchBtn").onclick = searchPrompts;
document.getElementById("searchInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") searchPrompts();
});

document.getElementById("backupBtn").onclick = function() {
  const ds = JSON.stringify(categories),
        b = new Blob([ds], { type: "application/json" }),
        u = URL.createObjectURL(b),
        a = document.createElement("a");
  a.href = u;
  a.download = "backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(u);
};

document.getElementById("importBtn").onclick = function() {
  document.getElementById("importFile").click();
};

document.getElementById("importFile").addEventListener("change", function(e) {
  const f = e.target.files[0];
  if (f) {
    const r = new FileReader();
    r.onload = function(e) {
      try {
        const d = JSON.parse(e.target.result);
        d.forEach(cc => {
          cc.id = cc.id || generateUniqueId();
          cc.prompts.forEach(pp => {
            pp.id = pp.id || generateUniqueId();
          });
        });
        categories.length = 0;
        categories.push(...d);
        pushToHistory();
        sortCategoriesAndPrompts();
        saveToLocalStorage();
        renderCategories();
        alert(translations[currentLanguage]["backupImported"]);
      } catch (er) {
        alert(translations[currentLanguage]["backupImportError"] + er.message);
      }
    };
    r.readAsText(f);
  }
});

function openEditModal(cId, pId) {
  currentEdit.categoryId = cId;
  currentEdit.promptId = pId;
  const c = categories.find(cc => cc.id === cId),
        p = c.prompts.find(pp => pp.id === pId);

  $("#editPromptTitle").val(p.title);
  $("#editPromptPurpose").val(p.purpose || "");
  quillEditPrompt.root.innerHTML = p.description;
  initTagsInput("editPromptTags", p.tags);
  $("#editPromptModal").modal("show");
}

$("#editPromptForm").on("submit", function(e) {
  e.preventDefault();
  const t = $("#editPromptTitle").val().trim(),
        pu = $("#editPromptPurpose").val().trim(),
        d = quillEditPrompt.root.innerHTML.trim(),
        tg = getTags("editPromptTags");

  if (t && pu && d && d !== "") {
    const c = categories.find(cc => cc.id === currentEdit.categoryId),
          p = c.prompts.find(pp => pp.id === currentEdit.promptId);
    pushToHistory();
    p.title = sanitizeHTML(t);
    p.purpose = sanitizeHTML(pu);
    p.description = d;
    p.tags = tg.map(tt => sanitizeHTML(tt));
    sortCategoriesAndPrompts();
    saveToLocalStorage();
    renderCategories();
    toggleCategoryBox(c.id);

    const cb = document.querySelector(`.category-box[data-category-id="${c.id}"]`),
          pt = cb.querySelectorAll(".prompt-titles-container .btn");
    pt.forEach(b => {
      if (b.textContent === p.title) b.click();
    });

    $("#editPromptModal").modal("hide");
  } else {
    alert(translations[currentLanguage]["promptTitlePurposeRequired"]);
  }
});

function initTagsInput(eId, iT = []) {
  const c = document.getElementById(eId);
  c.innerHTML = "";
  const inp = document.createElement("input");
  inp.type = "text";
  inp.placeholder = translations[currentLanguage]["addTag"] || "Aggiungi tag...";
  c.appendChild(inp);

  const tags = [...iT];
  function addTag(t) {
    if (t && !tags.includes(t)) {
      tags.push(t);
      const ts = document.createElement("span");
      ts.className = "tag";
      ts.textContent = t;
      const ri = document.createElement("i");
      ri.className = "fas fa-times";
      ri.onclick = () => {
        tags.splice(tags.indexOf(t), 1);
        c.removeChild(ts);
      };
      ts.appendChild(ri);
      c.insertBefore(ts, inp);
      inp.value = "";
    }
  }
  inp.addEventListener("keydown", function(e) {
    if (e.key === "Enter" || e.key === ",") {
      e.preventDefault();
      addTag(inp.value.trim());
    }
  });
  iT.forEach(tt => addTag(tt));
}

function getTags(eId) {
  const c = document.getElementById(eId),
        ts = c.querySelectorAll(".tag");
  return Array.from(ts).map(x => x.childNodes[0].nodeValue.trim());
}

function resetTags(eId) {
  document.getElementById(eId).innerHTML = "";
}

function sharePrompt(p) {
  if (navigator.share) {
    navigator.share({
      title: p.title,
      text: p.description
    }).catch(e => console.error(translations[currentLanguage]["shareError"], e));
  } else {
    const d = document.createElement("div");
    d.innerHTML = p.description;
    const txt = d.textContent || d.innerText || "";
    navigator.clipboard.writeText(p.title + "\n\n" + txt)
      .then(() => alert(translations[currentLanguage]["promptCopied"]))
      .catch(e => console.error(e));
  }
}

function toggleFavorite(p, fb) {
  pushToHistory();
  p.favorite = !p.favorite;
  saveToLocalStorage();
  fb.innerHTML = p.favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
  fb.title = p.favorite
    ? translations[currentLanguage]["removeFromFavorites"]
    : translations[currentLanguage]["addToFavorites"];
}

function toggleFavoritesView(b) {
  clearSearchResults();
  document.querySelectorAll(".category-box").forEach(x => x.style.display = "none");
  document.querySelectorAll("#categories .btn").forEach(d => {
    d.classList.remove("btn-success");
    d.classList.add("btn-secondary");
  });
  b.classList.remove("btn-secondary");
  b.classList.add("btn-success");
  renderFavorites();
}

function renderFavorites() {
  const pdc = document.getElementById("prompts-display-container");
  pdc.innerHTML = "";

  const h = document.createElement("h2");
  h.textContent = translations[currentLanguage]["favoritesHeading"];
  pdc.appendChild(h);

  let favsFound = false;
  const ftc = document.createElement("div");
  ftc.className = "favorite-titles-container d-flex flex-wrap";
  const sfc = document.createElement("div");
  sfc.className = "selected-favorite-container";

  const fps = [];
  categories.forEach(c => {
    c.prompts.forEach(p => {
      if (p.favorite) fps.push({ prompt: p, categoryId: c.id });
    });
  });

  fps.sort((a, b) => a.prompt.title.localeCompare(b.prompt.title, currentLanguage));

  fps.forEach(i => {
    favsFound = true;
    const b = document.createElement("button");
    b.className = "btn btn-secondary mr-2 mb-2";
    b.textContent = i.prompt.title;
    b.onclick = () => displayFavoritePrompt(i.prompt, i.categoryId, sfc, b);
    ftc.appendChild(b);
  });

  if (favsFound) {
    pdc.appendChild(ftc);
    pdc.appendChild(sfc);
  } else {
    const nf = document.createElement("p");
    nf.textContent = translations[currentLanguage]["noFavoritesFound"];
    pdc.appendChild(nf);
  }
}

function displaySubcategoryPrompts(subCat, parentCategoryId, categoryBox) {
  const ptc = categoryBox.querySelector(".prompt-titles-container");
  const spc = categoryBox.querySelector(".selected-prompt-container");
  
  // Clear current prompts display
  ptc.innerHTML = "";
  spc.innerHTML = "";
  
  // Add back button
  const backBtn = document.createElement("button");
  backBtn.className = "btn btn-secondary btn-sm mr-2 mb-2";
  backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Torna alla categoria';
  backBtn.onclick = () => {
    renderCategories();
    toggleCategoryBox(parentCategoryId);
  };
  ptc.appendChild(backBtn);
  
  // Add subcategory title
  const subTitle = document.createElement("h5");
  subTitle.textContent = subCat.name;
  subTitle.className = "mb-3 mr-4";
  subTitle.style.display = "inline-block";
  subTitle.style.marginRight = "20px";
  subTitle.style.color = "white";
  ptc.appendChild(subTitle);
  
  // Add subcategory prompts
  subCat.prompts.forEach(p => {
    ptc.appendChild(createPromptTitleDiv(p, parentCategoryId));
  });
  
  // Add button to create new prompt in subcategory
  const newPromptBtn = document.createElement("button");
  newPromptBtn.className = "btn btn-success btn-sm";
  newPromptBtn.innerHTML = '<i class="fas fa-plus"></i> Nuovo Prompt';
  newPromptBtn.onclick = () => showNewPromptForm(parentCategoryId, subCat.id);
  ptc.appendChild(newPromptBtn);
}

function displayFavoritePrompt(p, cId, cont, btn) {
  cont.innerHTML = "";
  const pd = createPromptContent(p, cId);
  cont.appendChild(pd);

  const ad = document.createElement("div");
  ad.className = "favorite-actions mt-3";

  const eB = createIconButton("info", "edit", translations[currentLanguage]["edit"]),
        cB = createIconButton("warning", "copy", translations[currentLanguage]["copy"]),
        sB = createIconButton("primary", "share-alt", translations[currentLanguage]["share"]),
        dB = createIconButton("danger", "trash", translations[currentLanguage]["delete"]),
        fB = createIconButton("secondary", "text-height", translations[currentLanguage]["increaseFont"]),
        rfB = createIconButton("danger", "trash", translations[currentLanguage]["delete"]);

  ad.append(eB, cB, sB, rfB, fB);
  cont.appendChild(ad);

  eB.onclick = e => {
    e.stopPropagation();
    openEditModal(cId, p.id);
  };
  cB.onclick = e => {
    e.stopPropagation();
    copyPromptText(p);
  };
  sB.onclick = e => {
    e.stopPropagation();
    sharePrompt(p);
  };
  fB.onclick = e => {
    e.stopPropagation();
    increaseFontSize(cont.querySelector(".display-prompt-text"));
  };
  rfB.onclick = e => {
    e.stopPropagation();
    if (confirm(translations[currentLanguage]["removeFromFavoritesConfirmation"])) {
      pushToHistory();
      p.favorite = false;
      saveToLocalStorage();
      renderFavorites();
    }
  };
}

function pushToHistory() {
  historyStack.push(JSON.stringify(categories));
  futureStack = [];
}

function undoAction() {
  if (historyStack.length > 0) {
    futureStack.push(JSON.stringify(categories));
    const ps = historyStack.pop(),
          st = JSON.parse(ps);
    categories.length = 0;
    categories.push(...st);
    saveToLocalStorage();
    renderCategories();
  }
}

function redoAction() {
  if (futureStack.length > 0) {
    historyStack.push(JSON.stringify(categories));
    const ns = futureStack.pop(),
          st = JSON.parse(ns);
    categories.length = 0;
    categories.push(...st);
    saveToLocalStorage();
    renderCategories();
  }
}

document.getElementById("undoBtn").onclick = undoAction;
document.getElementById("redoBtn").onclick = redoAction;

document.getElementById("cleanupBtn").onclick = function() {
  if (confirm("Vuoi rimuovere tutte le sottocategorie con nomi non validi?")) {
    pushToHistory();
    
    categories.forEach(c => {
      if (c.subcategories) {
        const beforeCount = c.subcategories.length;
        c.subcategories = c.subcategories.filter(subCat => {
          if (!subCat.name || subCat.name.trim() === "") return false;
          
          const cleanName = subCat.name.trim();
          
          // Extremely strict filtering - same as loading filter
          if (cleanName.length < 3) return false;
          if (cleanName.match(/^[a-z]{1,2}$/i)) return false;
          if (cleanName.match(/^[a-z\s]*v$/i)) return false;
          if (cleanName.match(/^y+$/i)) return false;
          if (cleanName.match(/^[a-z]+\s*v\s*$/i)) return false;
          if (cleanName.match(/^mb[a-z]*\s*v?$/i)) return false;
          if (cleanName.match(/^cd[a-z]*$/i)) return false;
          if (cleanName.match(/^[a-z]{1,6}\s*v?\s*$/i)) return false;
          if (cleanName.match(/^[bcdfghjklmnpqrstvwxyz]{1,4}$/i)) return false;
          if (cleanName.match(/^[bcdfghjklmnpqrstvwxyz]+$/i)) return false;
          if (cleanName.match(/^[aeiou]{1,3}$/i)) return false;
          if (cleanName.match(/^c+d*a*$/i)) return false;
          if (cleanName.match(/^[cda]+$/i)) return false;
          if (cleanName.match(/^[xyz]+$/i)) return false;
          if (cleanName.match(/^\w{1,3}$/)) return false;
          if (!cleanName.match(/[aeiou]/i)) return false;
          if (cleanName.match(/^[qwerty]+$/i)) return false;
          if (cleanName.match(/^[asdf]+$/i)) return false;
          if (cleanName.match(/^[zxcv]+$/i)) return false;
          
          const invalidPatterns = [
            /^[a-z]\1{2,}$/i,
            /^[a-z]{1,2}[a-z]\2+$/i,
            /^(.)(.)\1\2+$/i,
          ];
          
          for (let pattern of invalidPatterns) {
            if (cleanName.match(pattern)) return false;
          }
          
          return true;
        });
        
        if (c.subcategories.length === 0) {
          delete c.subcategories;
        }
        
        if (beforeCount > c.subcategories.length) {
          console.log(`Rimossi ${beforeCount - c.subcategories.length} sottocategorie invalide da ${c.name}`);
        }
      }
    });
    
    saveToLocalStorage();
    renderCategories();
    alert("Pulizia completata!");
  }
};

loadFromLocalStorage();
pushToHistory();
translatePage();
</script>
</body>
</html>
